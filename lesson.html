<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 1 ‚Äì Greetings and Introductions</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --primary-color: #2d5a87;
            --secondary-color: #4a90a4;
            --accent-color: #f39c12;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f5f7fa;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(18, 38, 63, 0.07);
            --shadow-hover: 0 12px 40px rgba(18, 38, 63, 0.12);
        }

        body {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        nav {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        .lesson-wrapper {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
        }

        .lesson-progress-floating {
            position: sticky;
            top: 64px;
            z-index: 70;
            padding: 0.55rem 0;
            margin: 0 -2rem 1.5rem;
            background: rgba(245, 247, 250, 0.92);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(45, 90, 135, 0.1);
        }

        .lesson-progress-floating .floating-content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .lesson-progress-floating .progress-info {
            display: flex;
            align-items: center;
            gap: 0.9rem;
            flex-wrap: wrap;
        }

        .lesson-progress-bar {
            display: flex;
            width: 190px;
            height: 7px;
            border-radius: 999px;
            background: rgba(45, 90, 135, 0.1);
            overflow: hidden;
        }

        .lesson-progress-bar.compact {
            height: 6px;
        }

        .lesson-progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .lesson-progress-fill-success {
            background: var(--success-color);
        }

        .lesson-progress-fill-mistake {
            background: rgba(231, 76, 60, 0.8);
        }

        .lesson-progress-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.35rem 0.7rem;
            border-radius: 999px;
            background: rgba(45, 90, 135, 0.08);
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .lesson-progress-pill.completed {
            background: rgba(39, 174, 96, 0.15);
            color: var(--success-color);
        }

        .lesson-progress-pill.warning {
            background: rgba(243, 156, 18, 0.18);
            color: #c47a0f;
        }

        .lesson-progress-pill.danger {
            background: rgba(231, 76, 60, 0.18);
            color: #c0392b;
        }

        .hero {
            margin-top: 1.5rem;
            background: linear-gradient(125deg, rgba(45, 90, 135, 0.92), rgba(15, 32, 54, 0.75)), url('assets/lesson-hero.jpg') center/cover;
            color: var(--white);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .hero h1 {
            font-size: 2.4rem;
            margin-bottom: 0.35rem;
        }

        .hero p {
            max-width: 720px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.85);
        }

        .lesson-progress-card {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: var(--white);
            padding: 1.75rem 2rem;
            border-radius: 20px;
            border: 1px solid rgba(45, 90, 135, 0.08);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            transition: border-color 0.2s;
        }

        .lesson-progress-card.completed {
            border-color: rgba(39, 174, 96, 0.3);
        }

        .lesson-progress-card.has-mistake {
            border-color: rgba(231, 76, 60, 0.25);
            box-shadow: 0 0 0 1px rgba(231, 76, 60, 0.1), var(--shadow);
        }

        .lesson-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .lesson-progress-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .lesson-progress-summary {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .lesson-progress-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.45rem 0.95rem;
            border-radius: 999px;
            background: rgba(45, 90, 135, 0.08);
            color: var(--primary-color);
            font-weight: 700;
        }

        .lesson-progress-badge.compact {
            padding: 0.25rem 0.65rem;
            font-size: 0.85rem;
        }

        .lesson-progress-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
        }

        .lesson-progress-metrics .metric {
            background: rgba(45, 90, 135, 0.06);
            border-radius: 14px;
            padding: 0.85rem 1rem;
        }

        .lesson-progress-metrics .metric-label {
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .lesson-progress-metrics .metric-value {
            font-size: 1.35rem;
            font-weight: 700;
        }

        .lesson-tabs {
            margin-top: 2.5rem;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.75rem;
        }

        .tab-button {
            padding: 0.6rem 1.4rem;
            border-radius: 999px;
            border: 1px solid rgba(45, 90, 135, 0.22);
            background: var(--white);
            color: var(--text-dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active,
        .tab-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        section h2 {
            color: var(--primary-color);
            margin-bottom: 1.25rem;
        }

        .table-card {
            background: var(--white);
            border-radius: 18px;
            border: 1px solid rgba(45, 90, 135, 0.08);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.75rem;
        }

        .table-card h3 {
            color: var(--primary-color);
            margin-bottom: 0.85rem;
        }

        .table-card table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-card th,
        .table-card td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid rgba(45, 90, 135, 0.12);
            text-align: left;
        }

        .table-card th {
            background: rgba(45, 90, 135, 0.08);
        }

        .mini-task {
            margin-top: 1.2rem;
            padding: 1rem 1.1rem;
            border-radius: 14px;
            background: rgba(45, 90, 135, 0.06);
            border: 1px dashed rgba(45, 90, 135, 0.25);
        }

        .mini-task h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .mini-options {
            margin-top: 0.6rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.55rem;
        }

        .mini-option {
            border: 1px solid rgba(45, 90, 135, 0.2);
            border-radius: 10px;
            background: var(--white);
            padding: 0.55rem 0.75rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .mini-option:hover:not(.disabled) {
            transform: translateY(-2px);
            border-color: var(--primary-color);
        }

        .mini-option.correct {
            background: rgba(39, 174, 96, 0.14);
            border-color: rgba(39, 174, 96, 0.45);
            color: var(--success-color);
        }

        .mini-option.incorrect {
            background: rgba(231, 76, 60, 0.12);
            border-color: rgba(231, 76, 60, 0.45);
            color: #c0392b;
        }

        .mini-question.completed-success {
            background: rgba(39, 174, 96, 0.12);
            border-color: rgba(39, 174, 96, 0.4);
        }

        .mini-question.has-mistake {
            background: rgba(231, 76, 60, 0.08);
            border-color: rgba(231, 76, 60, 0.35);
        }

        .mini-feedback {
            margin-top: 0.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .mini-task-reset {
            border: none;
            background: transparent;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            border-radius: 8px;
        }

        .mini-task-reset:hover {
            background: rgba(45, 90, 135, 0.12);
        }

        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .vocab-card {
            background: var(--white);
            border: 1px solid rgba(45, 90, 135, 0.12);
            border-radius: 14px;
            padding: 1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .vocab-word {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .card-actions {
            margin-top: auto;
            display: flex;
            gap: 0.5rem;
        }

        .card-actions button {
            flex: 1;
            border: 1px solid rgba(45, 90, 135, 0.12);
            border-radius: 8px;
            padding: 0.45rem 0.65rem;
            background: var(--white);
            cursor: pointer;
            font-weight: 600;
        }

        .card-actions button.know {
            color: var(--success-color);
            border-color: rgba(39, 174, 96, 0.35);
        }

        .card-actions button.practice {
            color: #c47a0f;
            border-color: rgba(243, 156, 18, 0.35);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 1000;
        }

        .modal-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            width: min(520px, calc(100% - 2.5rem));
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-hover);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            border: none;
            background: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-word {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .modal-translation {
            margin-top: 0.35rem;
            color: var(--text-light);
        }

        .modal-meta {
            margin-top: 0.3rem;
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .activity-card {
            background: var(--white);
            border-radius: 16px;
            border: 1px solid rgba(45, 90, 135, 0.12);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.6rem;
        }

        .activity-card.has-mistake {
            border-color: rgba(231, 76, 60, 0.35);
            box-shadow: 0 0 0 1px rgba(231, 76, 60, 0.25), var(--shadow);
        }

        .matching-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.6rem;
        }

        .matching-btn {
            padding: 0.6rem 0.7rem;
            border-radius: 10px;
            border: 1px solid rgba(45, 90, 135, 0.18);
            background: var(--white);
            cursor: pointer;
        }

        .matching-btn.selected {
            border-color: var(--primary-color);
            background: rgba(45, 90, 135, 0.12);
        }

        .matching-btn.correct {
            border-color: rgba(39, 174, 96, 0.35);
            background: rgba(39, 174, 96, 0.12);
            color: var(--success-color);
            cursor: default;
        }

        .matching-btn.disabled {
            opacity: 0.55;
            cursor: default;
        }

        .dialogue-grid {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .dialogue-btn {
            flex: 1;
            min-width: 150px;
            border: 1px solid rgba(45, 90, 135, 0.2);
            border-radius: 12px;
            padding: 0.65rem 1rem;
            cursor: pointer;
            background: var(--white);
            transition: transform 0.2s;
        }

        .dialogue-btn:hover:not(.correct):not(.incorrect) {
            transform: translateY(-2px);
        }

        .dialogue-btn.correct {
            border-color: rgba(39, 174, 96, 0.35);
            background: rgba(39, 174, 96, 0.12);
            color: var(--success-color);
        }

        .dialogue-btn.incorrect {
            border-color: rgba(231, 76, 60, 0.35);
            background: rgba(231, 76, 60, 0.12);
            color: #c0392b;
        }

        .flashcards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .flashcard {
            border-radius: 14px;
            border: 1px solid rgba(45, 90, 135, 0.12);
            background: var(--white);
            box-shadow: var(--shadow);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
            background: rgba(45, 90, 135, 0.12);
        }

        .challenge-card {
            background: var(--white);
            border-radius: 16px;
            border: 1px solid rgba(45, 90, 135, 0.12);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            text-align: center;
        }

        .challenge-card button {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            background: var(--primary-color);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .challenge-card button.done {
            background: var(--success-color);
        }

        .challenge-card button:hover {
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .lesson-wrapper {
                padding: 0 1.25rem 3rem;
            }

            nav {
                flex-direction: column;
                gap: 0.75rem;
            }

            .hero {
                padding: 2rem;
            }

            .lesson-progress-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .lesson-progress-summary {
                width: 100%;
            }

            .lesson-progress-floating {
                top: 56px;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">üá≤üá™ Learn Montenegrin</div>
            <div class="nav-links">
                <a href="index.html">Dashboard</a>
                <a href="lessons.html">Lessons</a>
                <a href="vocab.html">Vocabulary</a>
                <a href="quiz.html">Quiz</a>
            </div>
        </nav>
    </header>

    <main class="lesson-wrapper">
        <div class="lesson-progress-floating" id="floating-progress">
            <div class="floating-content">
                <div class="progress-info">
                    <span class="lesson-progress-pill" id="floating-progress-pill">0% ready</span>
                    <div class="lesson-progress-bar compact">
                        <div class="lesson-progress-fill lesson-progress-fill-success" id="floating-progress-fill-success"></div>
                        <div class="lesson-progress-fill lesson-progress-fill-mistake" id="floating-progress-fill-mistake"></div>
                    </div>
                </div>
                <button type="button" class="pill-btn outline" id="floating-retake-btn">Retake</button>
            </div>
        </div>

        <section class="hero">
            <h1>Lesson 1: Greetings and Introductions</h1>
            <p><strong>Level:</strong> A1 &nbsp;‚Ä¢&nbsp; <strong>Goal:</strong> Learn how to greet people, introduce yourself, and use basic polite expressions in Montenegrin/Serbian.</p>
        </section>

        <section class="lesson-progress-card" id="lesson-progress-card">
            <div class="lesson-progress-header">
                <div>
                    <h2>Lesson Progress</h2>
                    <p id="lesson-status-text">Not started</p>
                </div>
                <div class="lesson-progress-summary">
                    <span class="lesson-progress-badge" id="lesson-completion-badge">0%</span>
                    <div class="lesson-progress-bar">
                        <div class="lesson-progress-fill lesson-progress-fill-success" id="lesson-progress-fill-success"></div>
                        <div class="lesson-progress-fill lesson-progress-fill-mistake" id="lesson-progress-fill-mistake"></div>
                    </div>
                    <button type="button" class="pill-btn outline" id="lesson-retake-btn">Retake lesson</button>
                </div>
            </div>
            <div class="lesson-progress-metrics">
                <div class="metric">
                    <span class="metric-label">Completed</span>
                    <span class="metric-value" id="lesson-completed-count">0 / 0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Successfully completed</span>
                    <span class="metric-value" id="lesson-success-count">0 / 0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mistakes</span>
                    <span class="metric-value" id="lesson-mistake-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Vocabulary</span>
                    <span class="metric-value" id="lesson-vocab-indicator">0 / 0</span>
                </div>
            </div>
        </section>

        <div class="lesson-tabs">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="guide">Lesson Guide</button>
                <button class="tab-button" data-tab="vocab">Vocabulary</button>
                <button class="tab-button" data-tab="practice">Practice Lab</button>
                <button class="tab-button" data-tab="challenge">Real-world Challenge</button>
            </div>

            <div class="tab-panel active" id="tab-guide">
                <section>
                    <h2>Lesson Guide</h2>

                    <div class="table-card">
                        <h3>0Ô∏è‚É£ Verb "biti" (to be)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Ja sam</td><td>I am</td></tr>
                                <tr><td>Ti si</td><td>You are (informal)</td></tr>
                                <tr><td>On / Ona / Ono je</td><td>He / She / It is</td></tr>
                                <tr><td>Mi smo</td><td>We are</td></tr>
                                <tr><td>Vi ste</td><td>You are (formal / plural)</td></tr>
                                <tr><td>Oni / One / Ona su</td><td>They are (masc. / fem. / neut.)</td></tr>
                            </tbody>
                        </table>
                        <p style="color: var(--text-light); margin-top: 0.75rem;">You'll use <strong>sam/si/je/smo/ste/su</strong> constantly when introducing yourself or describing people.</p>
                        <div class="mini-task" data-task-id="biti-forms">
                            <h4>Mini quiz</h4>
                            <p class="mini-task-intro">Pick the correct form of <strong>biti</strong> for each sentence.</p>
                            <div class="mini-question" data-question-id="biti-1">
                                <p><strong>Q1.</strong> Ja ___ profesor.</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">sam</button>
                                    <button type="button" class="mini-option" data-correct="false">je</button>
                                    <button type="button" class="mini-option" data-correct="false">ste</button>
                                    <button type="button" class="mini-option" data-correct="false">su</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="biti-2">
                                <p><strong>Q2.</strong> Mi ___ iz Podgorice.</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">sam</button>
                                    <button type="button" class="mini-option" data-correct="false">si</button>
                                    <button type="button" class="mini-option" data-correct="true">smo</button>
                                    <button type="button" class="mini-option" data-correct="false">su</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>‚ùì Asking Questions with "biti"</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Da li sam...?</td><td>Am I...?</td></tr>
                                <tr><td>Da li si...?</td><td>Are you...? (informal)</td></tr>
                                <tr><td>Da li je...?</td><td>Is he / she / it...?</td></tr>
                                <tr><td>Da li smo...?</td><td>Are we...?</td></tr>
                                <tr><td>Da li ste...?</td><td>Are you...? (formal / plural)</td></tr>
                                <tr><td>Da li su...?</td><td>Are they...?</td></tr>
                            </tbody>
                        </table>
                        <p style="color: var(--text-light); margin-top: 0.75rem;">
                            In everyday speech you will also hear short forms such as <strong>Jesi li?</strong> (Are you?) or <strong>Je li?</strong> (Is he/she/it?).
                            They simply switch the verb and pronoun‚Äî<em>Jesi li</em> = <em>Da li si</em>. When people speak even faster, these can shrink further to
                            <strong>Je l' si?</strong> or just <strong>Je l'?</strong>. As a learner you can safely use <strong>Da li + verb</strong> everywhere, but recognising the short forms will help you follow native conversations.
                        </p>
                        <div class="mini-task" data-task-id="biti-questions">
                            <h4>Quick check</h4>
                            <p class="mini-task-intro">Test how to build yes/no questions with <strong>biti</strong>.</p>
                            <div class="mini-question" data-question-id="biti-q1">
                                <p><strong>Q1.</strong> Which sentence means "Are you (formal) from Serbia?"</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">Da li si iz Srbije?</button>
                                    <button type="button" class="mini-option" data-correct="true">Da li ste iz Srbije?</button>
                                    <button type="button" class="mini-option" data-correct="false">Je li iz Srbije?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="biti-q2">
                                <p><strong>Q2.</strong> Choose the short form that also means "Are you?" (informal).</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Jesi li?</button>
                                    <button type="button" class="mini-option" data-correct="false">Je li?</button>
                                    <button type="button" class="mini-option" data-correct="false">Jesmo li?</button>
                                    <button type="button" class="mini-option" data-correct="false">Jesam li?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>üö´ Negative Forms of "biti"</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Nisam</td><td>I am not</td></tr>
                                <tr><td>Nisi</td><td>You are not (informal)</td></tr>
                                <tr><td>Nije</td><td>He / She / It is not</td></tr>
                                <tr><td>Nismo</td><td>We are not</td></tr>
                                <tr><td>Niste</td><td>You are not (formal / plural)</td></tr>
                                <tr><td>Nisu</td><td>They are not</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="biti-negative">
                            <h4>Try this</h4>
                            <p class="mini-task-intro">Choose the correct negative form in each sentence.</p>
                            <div class="mini-question" data-question-id="biti-neg-1">
                                <p><strong>Q1.</strong> Ona ___ doktor.</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">nisam</button>
                                    <button type="button" class="mini-option" data-correct="true">nije</button>
                                    <button type="button" class="mini-option" data-correct="false">nismo</button>
                                    <button type="button" class="mini-option" data-correct="false">nisu</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="biti-neg-2">
                                <p><strong>Q2.</strong> Turn "Mi smo studenti." into the correct negative sentence.</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Mi nismo studenti.</button>
                                    <button type="button" class="mini-option" data-correct="false">Mi nisu studenti.</button>
                                    <button type="button" class="mini-option" data-correct="false">Mi nisam studenti.</button>
                                    <button type="button" class="mini-option" data-correct="false">Mi niste studenti.</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>üí¨ Sample Sentences</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Da li si iz Crne Gore?</td><td>Are you from Montenegro?</td></tr>
                                <tr><td>Jesi li student?</td><td>Are you a student?</td></tr>
                                <tr><td>Nisam iz Engleske.</td><td>I am not from England.</td></tr>
                                <tr><td>Mi nismo turisti.</td><td>We are not tourists.</td></tr>
                                <tr><td>Oni su prijatelji, zar ne?</td><td>They are friends, aren't they?</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="biti-dialogue">
                            <h4>Use it</h4>
                            <p class="mini-task-intro">Match questions and answers from everyday introductions.</p>
                            <div class="mini-question" data-question-id="biti-dialogue-1">
                                <p><strong>Q1.</strong> Best reply to "Da li si student?"</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Jesam, studiram jezike.</button>
                                    <button type="button" class="mini-option" data-correct="false">Nisam iz Crne Gore.</button>
                                    <button type="button" class="mini-option" data-correct="false">Mi smo prijatelji.</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="biti-dialogue-2">
                                <p><strong>Q2.</strong> What does "Mi nismo turisti." mean?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">We are tourists.</button>
                                    <button type="button" class="mini-option" data-correct="true">We are not tourists.</button>
                                    <button type="button" class="mini-option" data-correct="false">Are we tourists?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>1Ô∏è‚É£ Basic Greetings</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                    <th>When to use</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Zdravo!</td><td>Hello!</td><td>Any time, neutral</td></tr>
                                <tr><td>ƒÜao!</td><td>Hi / Bye</td><td>Informal</td></tr>
                                <tr><td>Dobro jutro!</td><td>Good morning</td><td>Before noon</td></tr>
                                <tr><td>Dobar dan!</td><td>Good day / afternoon</td><td>Noon ‚Äì 6 pm</td></tr>
                                <tr><td>Dobro veƒçe!</td><td>Good evening</td><td>After 6 pm</td></tr>
                                <tr><td>Laku noƒá!</td><td>Good night</td><td>Before going to bed</td></tr>
                                <tr><td>Doviƒëenja!</td><td>Goodbye</td><td>Polite/formal</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="greetings-time">
                            <h4>Practice</h4>
                            <p class="mini-task-intro">Choose the best greeting for each situation.</p>
                            <div class="mini-question" data-question-id="greetings-1">
                                <p><strong>Q1.</strong> It's 08:00 in the morning. What do you say?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Dobro jutro!</button>
                                    <button type="button" class="mini-option" data-correct="false">Dobro veƒçe!</button>
                                    <button type="button" class="mini-option" data-correct="false">ƒÜao!</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="greetings-2">
                                <p><strong>Q2.</strong> You want to say goodbye politely in a shop.</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Doviƒëenja!</button>
                                    <button type="button" class="mini-option" data-correct="false">Zdravo!</button>
                                    <button type="button" class="mini-option" data-correct="false">Laku noƒá!</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>2Ô∏è‚É£ Introducing Yourself</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Ja sam Ana.</td><td>I am Ana.</td></tr>
                                <tr><td>Ja sam iz Engleske.</td><td>I am from England.</td></tr>
                                <tr><td>Kako se zove≈°?</td><td>What's your name? (informal)</td></tr>
                                <tr><td>Kako se zovete?</td><td>What's your name? (formal)</td></tr>
                                <tr><td>Drago mi je.</td><td>Nice to meet you.</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="introductions">
                            <h4>Your turn</h4>
                            <p class="mini-task-intro">Pick the sentences that match the English prompts.</p>
                            <div class="mini-question" data-question-id="intro-1">
                                <p><strong>Q1.</strong> Which sentence means "I am from England"?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Ja sam iz Engleske.</button>
                                    <button type="button" class="mini-option" data-correct="false">Ja sam Ana.</button>
                                    <button type="button" class="mini-option" data-correct="false">Kako se zove≈°?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="intro-2">
                                <p><strong>Q2.</strong> How do you ask someone's name politely (formal)?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">Kako se zove≈°?</button>
                                    <button type="button" class="mini-option" data-correct="true">Kako se zovete?</button>
                                    <button type="button" class="mini-option" data-correct="false">Gde ≈æivi≈°?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>3Ô∏è‚É£ How are you?</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Kako si?</td><td>How are you? (informal)</td></tr>
                                <tr><td>Kako ste?</td><td>How are you? (formal/plural)</td></tr>
                                <tr><td>Dobro, hvala.</td><td>Fine, thank you.</td></tr>
                                <tr><td>Nije lo≈°e.</td><td>Not bad.</td></tr>
                                <tr><td>Odliƒçno!</td><td>Excellent!</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="feelings">
                            <h4>Check in</h4>
                            <p class="mini-task-intro">Select the response or question that fits best.</p>
                            <div class="mini-question" data-question-id="feelings-1">
                                <p><strong>Q1.</strong> What's a natural reply to "Kako si?"</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Dobro, hvala.</button>
                                    <button type="button" class="mini-option" data-correct="false">Ja sam iz Engleske.</button>
                                    <button type="button" class="mini-option" data-correct="false">Vidimo se!</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="feelings-2">
                                <p><strong>Q2.</strong> Which version is formal?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">Kako si?</button>
                                    <button type="button" class="mini-option" data-correct="true">Kako ste?</button>
                                    <button type="button" class="mini-option" data-correct="false">Kako sam?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>4Ô∏è‚É£ Polite Words</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Hvala</td><td>Thank you</td></tr>
                                <tr><td>Molim</td><td>Please / You're welcome</td></tr>
                                <tr><td>Izvinite</td><td>Excuse me / Sorry</td></tr>
                                <tr><td>Nema na ƒçemu</td><td>Don't mention it</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="polite">
                            <h4>Mind your manners</h4>
                            <p class="mini-task-intro">Connect each polite word with its meaning.</p>
                            <div class="mini-question" data-question-id="polite-1">
                                <p><strong>Q1.</strong> Which word would you use for "Excuse me / Sorry"?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">Hvala</button>
                                    <button type="button" class="mini-option" data-correct="false">Molim</button>
                                    <button type="button" class="mini-option" data-correct="true">Izvinite</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="polite-2">
                                <p><strong>Q2.</strong> Someone says "Hvala!" ‚Äî what's a friendly reply?</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Nema na ƒçemu.</button>
                                    <button type="button" class="mini-option" data-correct="false">ƒÜao!</button>
                                    <button type="button" class="mini-option" data-correct="false">Drago mi je.</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <h3>5Ô∏è‚É£ Useful Phrases</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Serbian</th>
                                    <th>English</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Zdravo, ja sam Marko.</td><td>Hello, I'm Marko.</td></tr>
                                <tr><td>Kako se zove≈°?</td><td>What's your name?</td></tr>
                                <tr><td>Drago mi je.</td><td>Nice to meet you.</td></tr>
                                <tr><td>Odakle si?</td><td>Where are you from?</td></tr>
                                <tr><td>Ja sam iz Crne Gore.</td><td>I'm from Montenegro.</td></tr>
                                <tr><td>Kako si? ‚Äì Dobro, hvala.</td><td>How are you? ‚Äì Fine, thanks.</td></tr>
                                <tr><td>Doviƒëenja!</td><td>Goodbye!</td></tr>
                            </tbody>
                        </table>
                        <div class="mini-task" data-task-id="phrases">
                            <h4>Build a mini-dialogue</h4>
                            <p class="mini-task-intro">Pick the phrase that fits each part of a first meeting.</p>
                            <div class="mini-question" data-question-id="phrases-1">
                                <p><strong>Q1.</strong> You want to introduce yourself at the start of a conversation.</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="true">Zdravo, ja sam Marko.</button>
                                    <button type="button" class="mini-option" data-correct="false">Doviƒëenja!</button>
                                    <button type="button" class="mini-option" data-correct="false">Kako si?</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-question" data-question-id="phrases-2">
                                <p><strong>Q2.</strong> Which question means "Where are you from?"</p>
                                <div class="mini-options">
                                    <button type="button" class="mini-option" data-correct="false">Kako se zove≈°?</button>
                                    <button type="button" class="mini-option" data-correct="true">Odakle si?</button>
                                    <button type="button" class="mini-option" data-correct="false">Drago mi je.</button>
                                </div>
                                <div class="mini-feedback"></div>
                            </div>
                            <div class="mini-task-actions">
                                <button type="button" class="mini-task-reset">Try again</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-panel" id="tab-vocab">
                <section>
                    <h2>üß† Core Vocabulary</h2>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Tap "I know" when a word feels comfortable. Progress is shared with the main vocabulary trainer.</p>
                    <div class="progress-wrapper">
                        <div class="progress-label lesson-progress-pill" id="progress-label">Loading progress‚Ä¶</div>
                        <div class="lesson-progress-bar" style="width: 100%;">
                            <div class="lesson-progress-fill lesson-progress-fill-success" id="progress-fill"></div>
                        </div>
                    </div>
                    <div id="vocab-grid" class="vocab-grid"></div>
                </section>
            </div>

            <div class="tab-panel" id="tab-practice">
                <section>
                    <h2>üéÆ Practice Lab</h2>

                    <div class="activity-card" id="mc-section">
                        <h3>üß© Multiple Choice</h3>
                        <div class="options-grid" data-activity="mc">
                            <div data-task-id="practice-mc-1">
                                <p><strong>Q1.</strong> How do you say "Good morning"?</p>
                                <button class="option-btn" data-correct="false">Dobro veƒçe</button>
                                <button class="option-btn" data-correct="false">Dobar dan</button>
                                <button class="option-btn" data-correct="true">Dobro jutro</button>
                                <button class="option-btn" data-correct="false">Laku noƒá</button>
                                <div class="feedback"></div>
                            </div>
                            <div data-task-id="practice-mc-2">
                                <p><strong>Q2.</strong> "Zdravo" means‚Ä¶</p>
                                <button class="option-btn" data-correct="false">Goodbye</button>
                                <button class="option-btn" data-correct="true">Hello</button>
                                <button class="option-btn" data-correct="false">See you</button>
                                <button class="option-btn" data-correct="false">Please</button>
                                <div class="feedback"></div>
                            </div>
                            <div data-task-id="practice-mc-3">
                                <p><strong>Q3.</strong> How do you say "Good night"?</p>
                                <button class="option-btn" data-correct="false">Dobro jutro</button>
                                <button class="option-btn" data-correct="false">Dobar dan</button>
                                <button class="option-btn" data-correct="true">Laku noƒá</button>
                                <button class="option-btn" data-correct="false">Zdravo</button>
                                <div class="feedback"></div>
                            </div>
                            <div data-task-id="practice-mc-4">
                                <p><strong>Q4.</strong> Choose the correct question: "___ ti student?"</p>
                                <button class="option-btn" data-correct="true">Da li si</button>
                                <button class="option-btn" data-correct="false">Da li je</button>
                                <button class="option-btn" data-correct="false">Da li ste</button>
                                <button class="option-btn" data-correct="false">Jesi li smo</button>
                                <div class="feedback"></div>
                            </div>
                            <div data-task-id="practice-mc-5">
                                <p><strong>Q5.</strong> Complete the sentence: "Mi ___ iz Srbije."</p>
                                <button class="option-btn" data-correct="false">nisam</button>
                                <button class="option-btn" data-correct="false">nisi</button>
                                <button class="option-btn" data-correct="true">nismo</button>
                                <button class="option-btn" data-correct="false">nisu</button>
                                <div class="feedback"></div>
                            </div>
                        </div>
                    </div>

                    <div class="activity-card" id="matching-section">
                        <h3>üîÅ Match the Pairs</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.75rem;">Tap one from the left column and then its match on the right.</p>
                        <div class="matching-grid" id="matching-left"></div>
                        <div class="matching-grid" id="matching-right" style="margin-top: 0.6rem;"></div>
                        <div class="feedback" id="matching-feedback"></div>
                    </div>

                    <div class="activity-card" id="qa-section">
                        <h3>ü§ù Connect the Conversation</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.75rem;">Match the question with the most natural reply.</p>
                        <div class="matching-grid" id="qa-left"></div>
                        <div class="matching-grid" id="qa-right" style="margin-top: 0.6rem;"></div>
                        <div class="feedback" id="qa-feedback"></div>
                    </div>

                    <div class="activity-card" id="select-section">
                        <h3>üß© Select the Correct Answer</h3>
                        <p><strong>Q:</strong> "Kako si?" means‚Ä¶</p>
                        <div class="options-grid" data-activity="select" data-task-id="practice-select-1">
                            <button class="option-btn" data-correct="false">Who are you?</button>
                            <button class="option-btn" data-correct="true">How are you?</button>
                            <button class="option-btn" data-correct="false">Where are you?</button>
                            <button class="option-btn" data-correct="false">What's your name?</button>
                        </div>
                        <div class="feedback"></div>
                    </div>

                    <div class="activity-card" id="dialogue-section">
                        <h3>üí¨ Dialogue Reconstruction</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.75rem;">Tap the cards in the correct order to make a friendly conversation.</p>
                        <div class="dialogue-grid" id="dialogue-grid"></div>
                        <div class="feedback" id="dialogue-feedback"></div>
                    </div>

                    <div class="activity-card" id="tf-section">
                        <h3>üß© True or False</h3>
                        <div class="tf-grid">
                            <div data-task-id="practice-tf-1">
                                <p>"Dobro jutro" = Good evening</p>
                                <button class="tf-btn" data-correct="false">True</button>
                                <button class="tf-btn" data-correct="true">False ‚úÖ</button>
                            </div>
                            <div data-task-id="practice-tf-2">
                                <p>"ƒÜao" can mean both Hi and Bye</p>
                                <button class="tf-btn" data-correct="true">True ‚úÖ</button>
                                <button class="tf-btn" data-correct="false">False</button>
                            </div>
                            <div data-task-id="practice-tf-3">
                                <p>"Hvala" means Please</p>
                                <button class="tf-btn" data-correct="false">True</button>
                                <button class="tf-btn" data-correct="true">False ‚úÖ</button>
                            </div>
                            <div data-task-id="practice-tf-4">
                                <p>"Kako ste?" is formal for How are you</p>
                                <button class="tf-btn" data-correct="true">True ‚úÖ</button>
                                <button class="tf-btn" data-correct="false">False</button>
                            </div>
                        </div>
                    </div>

                    <div class="activity-card" id="flashcard-section">
                        <h3>üïπ Flashcard Game</h3>
                        <p style="color: var(--text-light); margin-bottom: 0.75rem;">Tap each card to reveal its Montenegrin meaning.</p>
                        <div class="flashcards" id="flashcards"></div>
                    </div>
                </section>
            </div>

            <div class="tab-panel" id="tab-challenge">
                <section>
                    <h2>üåç Real-Life Challenge</h2>
                    <div class="challenge-card">
                        <p>You've just learned how to greet people and introduce yourself ‚Äî that's your first real conversation in Montenegrin/Serbian! üéâ</p>
                        <ol style="text-align: left; margin: 1rem auto; color: var(--text-light); line-height: 1.7;">
                            <li>Greet someone around you in Serbian.</li>
                            <li>Say something simple: "Zdravo! Ja sam [your name]. Kako si?"</li>
                            <li>Smile and enjoy the connection in a new language.</li>
                        </ol>
                        <button id="challenge-btn">I did it!!</button>
                        <div class="feedback" id="challenge-feedback"></div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <div class="modal-backdrop">
        <div class="modal">
            <button class="modal-close" aria-label="Close">√ó</button>
            <div class="modal-word-row">
                <div class="modal-word" id="modal-word"></div>
                <span class="modal-badge" id="modal-level" hidden></span>
            </div>
            <div class="modal-translation" id="modal-translation"></div>
            <div class="modal-meta" id="modal-category" hidden></div>
            <div class="modal-meta" id="modal-plural" hidden></div>
            <div class="modal-status" id="modal-status"></div>
            <div class="modal-section" id="modal-conjugations" hidden>
                <h4>Present tense</h4>
                <div class="verb-table">
                    <table>
                        <thead><tr><th>Pronoun</th><th>Form</th></tr></thead>
                        <tbody id="modal-conjugations-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-section" id="modal-lessons" hidden>
                <h4>Appears in lessons</h4>
                <div class="modal-list" id="modal-lessons-list"></div>
            </div>
            <div class="modal-section" id="modal-notes" hidden>
                <h4>Notes</h4>
                <div class="modal-list" id="modal-note-text"></div>
            </div>
            <div class="modal-actions">
                <button class="primary" id="modal-know-btn">I know</button>
                <button class="secondary" id="modal-dont-know-btn">Practice again</button>
            </div>
        </div>
    </div>

    <script src="lessons-data.js"></script>
    <script src="vocab/vocab-data.js"></script>
    <script>
        const CATEGORY_LABELS = {
            pronoun: 'Pronouns',
            verb: 'Verbs',
            noun: 'Nouns',
            adjective: 'Adjectives',
            adverb: 'Adverbs & Particles',
            phrase: 'Phrases',
            reference: 'References',
            note: 'Notes',
            focus: 'Focus',
            other: 'Other'
        };
        const CATEGORY_ORDER = ['pronoun', 'verb', 'noun', 'adjective', 'adverb', 'phrase', 'reference', 'focus', 'note', 'other'];
        const PROGRESS_KEY = 'vocab_progress_all';
        const LESSON_TASK_PROGRESS_KEY = 'lesson1_task_progress_v1';
        const LESSON_OVERVIEW_PROGRESS_KEY = 'lesson_overview_progress_v1';

        let wordProgress = {};
        let cardRegistry = new Map();
        let allWordKeys = [];
        let currentModalWordKey = null;
        let currentModalLevel = null;
        let lessonTaskProgress = { tasks: {} };
        const trackedTaskIds = new Set();
        let vocabularySummary = { known: 0, total: 0, percent: 0 };

        const vocabGrid = document.getElementById('vocab-grid');
        const progressLabelEl = document.getElementById('progress-label');
        const progressFillEl = document.getElementById('progress-fill');
        const lessonProgressCard = document.getElementById('lesson-progress-card');
        const lessonStatusText = document.getElementById('lesson-status-text');
        const lessonCompletionBadge = document.getElementById('lesson-completion-badge');
        const lessonProgressFillSuccess = document.getElementById('lesson-progress-fill-success');
        const lessonProgressFillMistake = document.getElementById('lesson-progress-fill-mistake');
        const lessonCompletedCount = document.getElementById('lesson-completed-count');
        const lessonSuccessCount = document.getElementById('lesson-success-count');
        const lessonMistakeCount = document.getElementById('lesson-mistake-count');
        const lessonVocabIndicator = document.getElementById('lesson-vocab-indicator');
        const lessonRetakeBtn = document.getElementById('lesson-retake-btn');
        const floatingProgress = document.getElementById('floating-progress');
        const floatingProgressPill = document.getElementById('floating-progress-pill');
        const floatingProgressFillSuccess = document.getElementById('floating-progress-fill-success');
        const floatingProgressFillMistake = document.getElementById('floating-progress-fill-mistake');
        const floatingRetakeBtn = document.getElementById('floating-retake-btn');

        const modalBackdrop = document.querySelector('.modal-backdrop');
        const modalWord = document.getElementById('modal-word');
        const modalLevel = document.getElementById('modal-level');
        const modalTranslation = document.getElementById('modal-translation');
        const modalCategory = document.getElementById('modal-category');
        const modalPlural = document.getElementById('modal-plural');
        const modalStatus = document.getElementById('modal-status');
        const modalConjugations = document.getElementById('modal-conjugations');
        const modalConjugationsBody = document.getElementById('modal-conjugations-body');
        const modalLessons = document.getElementById('modal-lessons');
        const modalLessonsList = document.getElementById('modal-lessons-list');
        const modalNotes = document.getElementById('modal-notes');
        const modalNoteText = document.getElementById('modal-note-text');
        const modalKnowBtn = document.getElementById('modal-know-btn');
        const modalDontKnowBtn = document.getElementById('modal-dont-know-btn');
        const modalCloseBtn = document.querySelector('.modal-close');

        function getWordKey(word) {
            return (word || '').toLowerCase();
        }

        function levelRank(level) {
            if (!level) return 999;
            const match = level.match(/^([A-Ca-c])(\d)/);
            if (!match) return 999;
            const groupMap = { A: 0, B: 10, C: 20 };
            const major = groupMap[match[1].toUpperCase()] ?? 99;
            const minor = parseInt(match[2], 10) || 0;
            return major + minor;
        }

        function primaryLevel(levels) {
            if (!levels || !levels.length) return null;
            return [...levels].sort((a, b) => levelRank(a) - levelRank(b))[0];
        }

        function getLevelClass(level) {
            if (!level) return null;
            const key = level.slice(0, 2).toLowerCase();
            return {
                a1: 'known-level-a1',
                a2: 'known-level-a2',
                b1: 'known-level-b1',
                b2: 'known-level-b2'
            }[key] || null;
        }

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                const parsed = stored ? JSON.parse(stored) : {};
                wordProgress = (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) ? parsed : {};
            } catch (error) {
                wordProgress = {};
            }
        }

        function saveProgress() {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(wordProgress));
            } catch (error) {}
        }

        function getWordStatus(key) {
            return wordProgress[key] === 'known' ? 'known' : 'unknown';
        }

        function setWordStatus(key, status) {
            wordProgress[key] = status === 'known' ? 'known' : 'unknown';
            saveProgress();
            updateCardGroup(key);
            updateModalStatus(key);
            updateProgressBar();
        }

        function updateCardVisual(card, status) {
            card.classList.remove('known', 'known-level-a1', 'known-level-a2', 'known-level-b1', 'known-level-b2');
            if (status === 'known') {
                card.classList.add('known');
                const levelClass = getLevelClass(card.dataset.level);
                if (levelClass) card.classList.add(levelClass);
            }
            const knowBtn = card.querySelector('button.know');
            const practiceBtn = card.querySelector('button.practice');
            if (knowBtn) knowBtn.hidden = status === 'known';
            if (practiceBtn) practiceBtn.hidden = status !== 'known';
        }

        function updateCardGroup(key) {
            const status = getWordStatus(key);
            (cardRegistry.get(key) || []).forEach(card => updateCardVisual(card, status));
        }

        function updateModalStatus(key) {
            if (currentModalWordKey !== key) return;
            const status = getWordStatus(key);
            modalStatus.textContent = '';
            modalStatus.hidden = true;
            modalKnowBtn.hidden = status === 'known';
            modalDontKnowBtn.hidden = status !== 'known';
        }

        function updateProgressBar() {
            const total = allWordKeys.length;
            if (!total) {
                progressLabelEl.textContent = 'No vocabulary words available yet.';
                if (progressFillEl) progressFillEl.style.width = '0%';
                vocabularySummary = { known: 0, total: 0, percent: 0 };
                updateVocabularyIndicator();
                updateLessonProgressUI();
                return;
            }
            let knownCount = 0;
            allWordKeys.forEach(key => {
                if (wordProgress[key] === 'known') knownCount += 1;
            });
            const percent = (knownCount / total) * 100;
            progressLabelEl.textContent = `You already know ${percent.toFixed(2)}% (${knownCount} of ${total})`;
            if (progressFillEl) progressFillEl.style.width = `${percent}%`;
            vocabularySummary = { known: knownCount, total, percent };
            updateVocabularyIndicator();
            updateLessonProgressUI();
        }

        function normalizeCategory(category) {
            const type = (category.type || '').toLowerCase();
            if (['pronoun', 'verb', 'noun', 'adjective', 'adverb', 'phrase', 'reference', 'focus', 'note'].includes(type)) {
                return type;
            }
            const name = (category.name || '').toLowerCase();
            if (name.includes('pronoun')) return 'pronoun';
            if (name.includes('verb')) return 'verb';
            if (name.includes('noun')) return 'noun';
            if (name.includes('adjective')) return 'adjective';
            if (name.includes('adverb')) return 'adverb';
            if (name.includes('phrase')) return 'phrase';
            if (name.includes('reference')) return 'reference';
            if (name.includes('focus')) return 'focus';
            if (name.includes('note')) return 'note';
            return 'other';
        }

        const NOUN_PLURAL_OVERRIDES = {
            'apoteka': 'apoteke', 'autobus': 'autobusi', 'avion': 'avioni', 'banka': 'banke', 'bol': 'bolovi',
            'brat': 'braƒáa', 'cena': 'cene', 'crna gora': 'Crne Gore', 'ƒçaj': 'ƒçajevi', 'ƒçovek': 'ljudi',
            'dan': 'dani', 'dete': 'deca', 'doktor': 'doktori', 'engleska': 'Engleske', 'film': 'filmovi',
            'glava': 'glave', 'gost': 'gosti', 'hleb': 'hlebovi', 'ime': 'imena', 'in≈æenjer': 'in≈æenjeri',
            'jesen': 'jeseni', 'jezik': 'jezici', 'jutro': 'jutra', 'kafa': 'kafe', 'karta': 'karte', 'ki≈°a': 'ki≈°e',
            'kljuƒç': 'kljuƒçevi', 'knjiga': 'knjige', 'kompanija': 'kompanije', 'konobar': 'konobari', 'krevet': 'kreveti',
            'kuƒáa': 'kuƒáe', 'lekar': 'lekari', 'leto': 'leta', 'majka': 'majke', 'mleko': 'mleka', 'muzika': 'muzike',
            'narod': 'narodi', 'noga': 'noge', 'novine': 'novine', 'orman': 'ormani', 'otac': 'oƒçevi', 'pivo': 'piva',
            'porodica': 'porodice', 'posao': 'poslovi', 'po≈°ta': 'po≈°te', 'povrƒáe': 'povrƒáa', 'prijatelj': 'prijatelji',
            'prodavnica': 'prodavnice', 'proleƒáe': 'proleƒáa', 'putovanje': 'putovanja', 'radnik': 'radnici', 'restoran': 'restorani',
            'ruka': 'ruke', 'rusija': 'Rusije', 'sestra': 'sestre', 'sir': 'sirevi', 'sneg': 'snegovi', 'soba': 'sobe',
            'sok': 'sokovi', 'sport': 'sportovi', 'sprat': 'spratovi', 'srbija': 'Srbije', 'sto': 'stolovi', 'stolica': 'stolice',
            'sunce': 'sunca', '≈°kola': '≈°kole', 'trg': 'trgovi', 'uƒçenik': 'uƒçenici', 'uƒçitelj': 'uƒçitelji', 'ulica': 'ulice',
            'veƒçe': 'veƒçeri', 'voƒáe': 'voƒáa', 'voda': 'vode', 'voz': 'vozovi', 'vreme': 'vremena', 'zemlja': 'zemlje', 'zima': 'zime', '≈æena': '≈æene'
        };

        function matchPluralCasing(word, plural) {
            if (!word || !plural) return plural || null;
            const first = word.charAt(0);
            if (first === first.toUpperCase()) {
                return plural.charAt(0).toUpperCase() + plural.slice(1);
            }
            return plural;
        }

        function deriveNounPlural(word) {
            if (!word) return null;
            const lower = word.toLowerCase();
            if (NOUN_PLURAL_OVERRIDES[lower]) return NOUN_PLURAL_OVERRIDES[lower];
            let plural = null;
            if (lower.endsWith('ac') || lower.endsWith('ak')) plural = lower.slice(0, -2) + 'ci';
            else if (lower.endsWith('ik')) plural = lower.slice(0, -2) + 'ici';
            else if (lower.endsWith('ok')) plural = lower + 'ovi';
            else if (lower.endsWith('aj') || lower.endsWith('oj') || lower.endsWith('ej')) plural = lower + 'evi';
            else if (lower.endsWith('ar') || lower.endsWith('er') || lower.endsWith('or') || lower.endsWith('ur')) plural = lower + 'i';
            else if (lower.endsWith('an') || lower.endsWith('en') || lower.endsWith('on')) plural = lower + 'i';
            else if (lower.endsWith('el') || lower.endsWith('ol') || lower.endsWith('al')) plural = lower + 'i';
            else if (lower.endsWith('a')) plural = lower.slice(0, -1) + 'e';
            else if (lower.endsWith('o') || lower.endsWith('e')) plural = lower.slice(0, -1) + 'a';
            else if (lower.endsWith('j') || lower.endsWith('ƒá') || lower.endsWith('ƒç') || lower.endsWith('ƒë') || lower.endsWith('≈°') || lower.endsWith('≈æ')) plural = lower + 'evi';
            else plural = lower + 'i';
            return matchPluralCasing(word, plural);
        }

        function resolveNounPlural(word, explicit) {
            if (explicit) return explicit;
            return deriveNounPlural(word);
        }

        function collectLessonVocabulary() {
            const lessonData = lessonsData['lesson1'];
            const vocabSet = lessonData.vocabularySet;
            const vocabSource = vocabularyData[vocabSet];
            if (!vocabSource) return [];

            const master = new Map();
            (vocabSource.categories || []).forEach(category => {
                const typeKey = normalizeCategory(category);
                (category.items || []).forEach(item => {
                    if (!item || !item.word) return;
                    const key = getWordKey(item.word);
                    if (!master.has(key)) {
                        master.set(key, {
                            word: item.word,
                            translation: item.translation || '',
                            conjugations: item.conjugations || null,
                            note: item.note || null,
                            reference: item.reference || null,
                            levels: new Set([lessonData.level]),
                            categories: new Set([category.name || CATEGORY_LABELS[typeKey] || typeKey || 'Other']),
                            categoryTypes: new Set([typeKey]),
                            plural: typeKey === 'noun' ? resolveNounPlural(item.word, item.plural) : null
                        });
                    } else {
                        const entry = master.get(key);
                        if (item.translation) entry.translation = item.translation;
                        if (item.conjugations) entry.conjugations = item.conjugations;
                        if (item.note) entry.note = item.note;
                        if (item.reference) entry.reference = item.reference;
                        entry.levels.add(lessonData.level);
                        if (category.name) entry.categories.add(category.name);
                        entry.categoryTypes.add(typeKey);
                        if (typeKey === 'noun' && !entry.plural) {
                            entry.plural = resolveNounPlural(item.word, item.plural);
                        }
                    }
                });
            });

            allWordKeys = Array.from(master.keys());

            return Array.from(master.values())
                .map(entry => {
                    const levels = Array.from(entry.levels);
                    return {
                        ...entry,
                        categories: Array.from(entry.categories || []),
                        categoryTypes: Array.from(entry.categoryTypes || []),
                        primaryLevel: primaryLevel(levels),
                        levels
                    };
                })
                .sort((a, b) => a.word.localeCompare(b.word, 'sr'));
        }

        function createVocabularyCard(item) {
            const card = document.createElement('div');
            card.className = 'vocab-card';
            card.dataset.level = (item.primaryLevel || '').toLowerCase();
            card.addEventListener('click', () => openModal(item));

            const wordEl = document.createElement('div');
            wordEl.className = 'vocab-word';
            wordEl.textContent = item.word;
            card.appendChild(wordEl);

            if (item.primaryLevel) {
                const levelEl = document.createElement('div');
                levelEl.className = 'lesson-progress-pill warning';
                levelEl.textContent = item.primaryLevel;
                card.appendChild(levelEl);
            }

            if (item.note || item.reference) {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-text';
                noteEl.textContent = item.note || item.reference;
                card.appendChild(noteEl);
            }

            const actions = document.createElement('div');
            actions.className = 'card-actions';

            const knowBtn = document.createElement('button');
            knowBtn.className = 'know';
            knowBtn.textContent = 'I know';
            knowBtn.addEventListener('click', event => {
                event.stopPropagation();
                setWordStatus(getWordKey(item.word), 'known');
            });

            const practiceBtn = document.createElement('button');
            practiceBtn.className = 'practice';
            practiceBtn.textContent = 'Practice again';
            practiceBtn.addEventListener('click', event => {
                event.stopPropagation();
                setWordStatus(getWordKey(item.word), 'unknown');
            });

            actions.appendChild(knowBtn);
            actions.appendChild(practiceBtn);
            card.appendChild(actions);

            const key = getWordKey(item.word);
            if (!cardRegistry.has(key)) cardRegistry.set(key, []);
            cardRegistry.get(key).push(card);
            updateCardVisual(card, getWordStatus(key));

            return card;
        }

        function renderVocabularyCards(vocabulary) {
            vocabGrid.innerHTML = '';
            cardRegistry = new Map();
            vocabulary.forEach(item => {
                vocabGrid.appendChild(createVocabularyCard(item));
            });
        }

        function openModal(item) {
            const key = getWordKey(item.word);
            currentModalWordKey = key;
            currentModalLevel = item.primaryLevel || null;

            modalWord.textContent = item.word;
            if (item.primaryLevel) {
                modalLevel.textContent = item.primaryLevel;
                modalLevel.hidden = false;
            } else {
                modalLevel.hidden = true;
            }
            modalTranslation.textContent = item.translation || '‚Äî';
            modalCategory.hidden = true;
            if (item.categoryTypes && item.categoryTypes.includes('noun')) {
                const pluralForm = resolveNounPlural(item.word, item.plural);
                if (pluralForm) {
                    modalPlural.textContent = `pl: ${pluralForm}`;
                    modalPlural.hidden = false;
                } else {
                    modalPlural.hidden = true;
                }
            } else {
                modalPlural.hidden = true;
            }

            if (item.conjugations) {
                modalConjugations.hidden = false;
                modalConjugationsBody.innerHTML = '';
                Object.entries(item.conjugations).forEach(([pronoun, form]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${pronoun}</td><td>${form}</td>`;
                    modalConjugationsBody.appendChild(row);
                });
            } else {
                modalConjugations.hidden = true;
            }

            modalLessons.hidden = true;

            if (item.note || item.reference) {
                modalNotes.hidden = false;
                modalNoteText.textContent = item.note || item.reference;
            } else {
                modalNotes.hidden = true;
            }

            updateModalStatus(key);
            modalBackdrop.classList.add('open');
        }

        function closeModal() {
            modalBackdrop.classList.remove('open');
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', event => {
            if (event.target === modalBackdrop) closeModal();
        });
        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') closeModal();
        });

        modalKnowBtn.addEventListener('click', () => {
            if (currentModalWordKey) setWordStatus(currentModalWordKey, 'known');
        });

        modalDontKnowBtn.addEventListener('click', () => {
            if (currentModalWordKey) setWordStatus(currentModalWordKey, 'unknown');
        });

        function ensureTaskEntry(taskId) {
            if (!taskId) return null;
            if (!lessonTaskProgress.tasks || typeof lessonTaskProgress.tasks !== 'object') {
                lessonTaskProgress.tasks = {};
            }
            if (!lessonTaskProgress.tasks[taskId]) {
                lessonTaskProgress.tasks[taskId] = { completed: false, success: false, mistakes: 0 };
            }
            return lessonTaskProgress.tasks[taskId];
        }

        function registerTask(taskId) {
            if (!taskId) return;
            trackedTaskIds.add(taskId);
            ensureTaskEntry(taskId);
        }

        function loadLessonTaskProgress() {
            try {
                const stored = localStorage.getItem(LESSON_TASK_PROGRESS_KEY);
                if (!stored) {
                    lessonTaskProgress = { tasks: {} };
                    return;
                }
                const parsed = JSON.parse(stored);
                if (parsed && typeof parsed === 'object') {
                    const tasks = parsed.tasks && typeof parsed.tasks === 'object' ? parsed.tasks : parsed;
                    lessonTaskProgress = { tasks: tasks || {} };
                } else {
                    lessonTaskProgress = { tasks: {} };
                }
            } catch (error) {
                lessonTaskProgress = { tasks: {} };
            }

            if (!lessonTaskProgress.tasks || typeof lessonTaskProgress.tasks !== 'object') {
                lessonTaskProgress.tasks = {};
            }

            Object.keys(lessonTaskProgress.tasks).forEach(key => {
                const entry = lessonTaskProgress.tasks[key];
                if (!entry || typeof entry !== 'object') {
                    lessonTaskProgress.tasks[key] = { completed: false, success: false, mistakes: 0 };
                } else {
                    lessonTaskProgress.tasks[key] = {
                        completed: entry.completed === true,
                        success: entry.success === true,
                        mistakes: Number(entry.mistakes) || 0
                    };
                }
            });
        }

        function saveLessonTaskProgress() {
            try {
                localStorage.setItem(LESSON_TASK_PROGRESS_KEY, JSON.stringify(lessonTaskProgress));
            } catch (error) {
                console.warn('Could not persist task progress', error);
            }
        }

        function markTaskSuccess(taskId) {
            if (!taskId) return;
            const entry = ensureTaskEntry(taskId);
            if (!entry) return;
            entry.completed = true;
            entry.success = true;
            saveLessonTaskProgress();
            updateLessonProgressUI();
        }

        function recordTaskMistake(taskId) {
            if (!taskId) return;
            const entry = ensureTaskEntry(taskId);
            if (!entry || entry.success) return;
            entry.completed = true;
            entry.mistakes = (entry.mistakes || 0) + 1;
            saveLessonTaskProgress();
            updateLessonProgressUI();
        }

        function resetTaskProgress(taskId) {
            if (!taskId) return;
            if (lessonTaskProgress.tasks && lessonTaskProgress.tasks[taskId]) {
                delete lessonTaskProgress.tasks[taskId];
                saveLessonTaskProgress();
                updateLessonProgressUI();
            }
        }

        function getTaskEntry(taskId) {
            if (!taskId || !lessonTaskProgress.tasks) return null;
            return lessonTaskProgress.tasks[taskId] || null;
        }

        function applyTaskStyling(element, entry) {
            if (!element) return;
            const hasMistake = !!(entry && entry.mistakes > 0 && !entry.success);
            const isSuccess = !!(entry && entry.success);
            element.classList.toggle('has-mistake', hasMistake);
            element.classList.toggle('completed-success', isSuccess);
        }

        function applyMiniQuestionState(question) {
            if (!question) return;
            const taskId = question.dataset.questionId || question.dataset.taskId;
            if (!taskId) return;
            const entry = getTaskEntry(taskId);
            applyTaskStyling(question, entry);
            const options = question.querySelectorAll('.mini-option');
            const feedback = question.querySelector('.mini-feedback');
            if (feedback) feedback.textContent = '';

            options.forEach(option => {
                option.classList.remove('correct', 'incorrect', 'disabled');
                option.disabled = false;
            });

            if (!entry) {
                question.dataset.completed = 'false';
                return;
            }

            if (entry.success) {
                question.dataset.completed = 'true';
                options.forEach(option => {
                    option.disabled = true;
                    if (option.dataset.correct === 'true') {
                        option.classList.add('correct');
                    } else {
                        option.classList.add('incorrect');
                    }
                });
                if (feedback) feedback.textContent = '‚úÖ Completed earlier';
            } else if (entry.mistakes > 0) {
                question.dataset.completed = 'false';
                if (feedback) feedback.textContent = '‚ùå Needs another try';
            }
        }

        function updateVocabularyIndicator() {
            if (!lessonVocabIndicator) return;
            const { known = 0, total = 0, percent = 0 } = vocabularySummary || {};
            if (!total) {
                lessonVocabIndicator.textContent = '0 / 0 known';
            } else {
                lessonVocabIndicator.textContent = `${known} / ${total} known (${Math.round(percent)}%)`;
            }
        }

        function persistLessonOverviewSummary(snapshot) {
            try {
                const stored = localStorage.getItem(LESSON_OVERVIEW_PROGRESS_KEY);
                const data = stored ? JSON.parse(stored) : {};
                data['lesson1'] = snapshot;
                localStorage.setItem(LESSON_OVERVIEW_PROGRESS_KEY, JSON.stringify(data));
                if (typeof updateLessonProgressPills === 'function') {
                    updateLessonProgressPills();
                }
            } catch (error) {
                console.warn('Failed to persist lesson overview summary', error);
            }
        }

        function updateLessonProgressUI() {
            if (!lessonProgressCard || !lessonStatusText || !lessonCompletionBadge || !lessonProgressFillSuccess || !lessonProgressFillMistake || !lessonCompletedCount || !lessonSuccessCount || !lessonMistakeCount) return;
            const total = trackedTaskIds.size;
            const tasks = lessonTaskProgress.tasks || {};
            let completed = 0;
            let success = 0;
            let mistakes = 0;
            trackedTaskIds.forEach(id => {
                const entry = tasks[id];
                if (entry?.completed) completed += 1;
                if (entry?.success) success += 1;
                if (entry?.mistakes) mistakes += entry.mistakes;
            });
            const percent = total ? (success / total) * 100 : 0;
            const clamped = Math.max(0, Math.min(100, percent));
            const finished = total > 0 && percent >= 80;
            const pending = Math.max(0, completed - success);
            const successPercent = total ? (success / total) * 100 : 0;
            const pendingPercent = total ? (pending / total) * 100 : 0;
            const mistakeExists = pending > 0;

            let status = 'Not started';
            if (completed > 0 && !finished) status = `In progress ‚Äî ${Math.round(clamped)}% success`;
            if (finished) status = 'Lesson completed (80% success reached)';
            lessonStatusText.textContent = status;
            lessonCompletionBadge.textContent = `${Math.round(clamped)}%`;
            lessonCompletionBadge.classList.toggle('completed', finished);
            lessonProgressCard.classList.toggle('completed', finished);
            lessonProgressCard.classList.toggle('has-mistake', mistakeExists);

            if (lessonProgressFillSuccess) lessonProgressFillSuccess.style.width = total ? `${successPercent}%` : '0%';
            if (lessonProgressFillMistake) lessonProgressFillMistake.style.width = total ? `${pendingPercent}%` : '0%';

            lessonCompletedCount.textContent = `${completed} / ${total}`;
            lessonSuccessCount.textContent = `${success} / ${total}`;
            lessonMistakeCount.textContent = `${mistakes}`;
            updateVocabularyIndicator();

            if (floatingProgress) {
                if (floatingProgressFillSuccess) floatingProgressFillSuccess.style.width = total ? `${successPercent}%` : '0%';
                if (floatingProgressFillMistake) floatingProgressFillMistake.style.width = total ? `${pendingPercent}%` : '0%';
                if (floatingProgressPill) {
                    floatingProgressPill.textContent = finished ? 'Lesson completed' : `${Math.round(clamped)}% ready`;
                    floatingProgressPill.classList.remove('completed', 'warning', 'danger');
                    if (finished) {
                        floatingProgressPill.classList.add('completed');
                    } else if (mistakeExists) {
                        floatingProgressPill.classList.add('danger');
                    } else if (completed > 0) {
                        floatingProgressPill.classList.add('warning');
                    }
                }
            }

            persistLessonOverviewSummary({
                success,
                total,
                mistakes,
                percent: Math.round(successPercent),
                status
            });
        }

        function resetMiniQuestion(question, resetProgress = false) {
            const options = question.querySelectorAll('.mini-option');
            const feedback = question.querySelector('.mini-feedback');
            options.forEach(option => {
                option.classList.remove('correct', 'incorrect', 'disabled');
                option.disabled = false;
            });
            if (feedback) feedback.textContent = '';
            question.dataset.completed = 'false';
            question.classList.remove('completed-success', 'has-mistake');
            if (resetProgress) {
                const taskId = question.dataset.questionId || question.dataset.taskId;
                if (taskId) resetTaskProgress(taskId);
            }
        }

        function handleMiniOptionClick(option, question) {
            if (question.dataset.completed === 'true') return;
            const taskId = question.dataset.questionId || question.dataset.taskId;
            const options = question.querySelectorAll('.mini-option');
            const feedback = question.querySelector('.mini-feedback');
            const isCorrect = option.dataset.correct === 'true';

            options.forEach(btn => {
                const btnCorrect = btn.dataset.correct === 'true';
                if (btnCorrect) {
                    btn.classList.add('correct');
                } else if (btn === option && !isCorrect) {
                    btn.classList.add('incorrect');
                } else if (btn !== option) {
                    btn.classList.add('disabled');
                }
                btn.disabled = true;
            });

            if (isCorrect) {
                if (feedback) feedback.textContent = '‚úÖ Bravo! You nailed it.';
                question.classList.add('completed-success');
                question.classList.remove('has-mistake');
                if (taskId) markTaskSuccess(taskId);
            } else {
                if (feedback) feedback.textContent = '‚ùå Not quite. The highlighted answer is correct.';
                question.classList.add('has-mistake');
                question.classList.remove('completed-success');
                if (taskId) recordTaskMistake(taskId);
                setTimeout(() => {
                    options.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('incorrect', 'disabled', 'correct');
                    });
                    question.dataset.completed = 'false';
                }, 600);
            }

            if (isCorrect) {
                question.dataset.completed = 'true';
            }

            if (taskId) {
                applyTaskStyling(question, getTaskEntry(taskId));
            }
        }

        function restoreMiniTasks() {
            const tasks = document.querySelectorAll('.mini-task');
            tasks.forEach(task => {
                const questions = task.querySelectorAll('.mini-question');
                questions.forEach(question => {
                    const taskId = question.dataset.questionId || question.dataset.taskId;
                    registerTask(taskId);
                    applyMiniQuestionState(question);
                    question.querySelectorAll('.mini-option').forEach(option => {
                        option.addEventListener('click', () => handleMiniOptionClick(option, question));
                    });
                });

                const resetBtn = task.querySelector('.mini-task-reset');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        questions.forEach(question => resetMiniQuestion(question, true));
                    });
                }
            });
        }

        function restoreMultipleChoiceState() {
            document.querySelectorAll('[data-activity="mc"] [data-task-id]').forEach(container => {
                const taskId = container.dataset.taskId;
                const entry = getTaskEntry(taskId);
                applyTaskStyling(container, entry);
                const feedback = container.querySelector('.feedback');
                if (feedback) feedback.textContent = '';
                container.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('correct', 'incorrect');
                    btn.disabled = false;
                });
                if (!entry) return;
                if (entry.success) {
                    container.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        if (btn.dataset.correct === 'true') btn.classList.add('correct');
                        else btn.classList.add('incorrect');
                    });
                    if (feedback) feedback.textContent = '‚úÖ Completed earlier';
                } else if (entry.mistakes > 0) {
                    if (feedback) feedback.textContent = '‚ùå Needs another try';
                }
            });
        }

        function restoreSelectState() {
            document.querySelectorAll('[data-activity="select"][data-task-id]').forEach(container => {
                const taskId = container.dataset.taskId;
                const entry = getTaskEntry(taskId);
                applyTaskStyling(container, entry);
                const feedback = container.nextElementSibling;
                if (feedback && feedback.classList.contains('feedback')) feedback.textContent = '';
                container.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('correct', 'incorrect');
                    btn.disabled = false;
                });
                if (!entry) return;
                if (entry.success) {
                    container.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        if (btn.dataset.correct === 'true') btn.classList.add('correct');
                        else btn.classList.add('incorrect');
                    });
                    if (feedback && feedback.classList.contains('feedback')) feedback.textContent = '‚úÖ Completed earlier';
                } else if (entry.mistakes > 0 && feedback && feedback.classList.contains('feedback')) {
                    feedback.textContent = '‚ùå Needs another try';
                }
            });
        }

        function restoreTrueFalseState() {
            document.querySelectorAll('.tf-grid > div[data-task-id]').forEach(group => {
                const taskId = group.dataset.taskId;
                const entry = getTaskEntry(taskId);
                applyTaskStyling(group, entry);
                const buttons = group.querySelectorAll('.tf-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('correct', 'incorrect');
                    btn.disabled = false;
                });
                if (!entry) return;
                if (entry.success) {
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        if (btn.dataset.correct === 'true') btn.classList.add('correct');
                        else btn.classList.add('incorrect');
                    });
                }
            });
        }

        function restoreMatchingState(containerId, leftId, rightId, feedbackId, taskId) {
            const container = document.getElementById(containerId);
            const left = document.getElementById(leftId);
            const right = document.getElementById(rightId);
            const feedback = document.getElementById(feedbackId);
            if (!container || !left || !right) return;
            const entry = getTaskEntry(taskId);
            applyTaskStyling(container, entry);
            if (feedback) feedback.textContent = '';
            if (entry?.success && feedback) feedback.textContent = '‚úÖ Completed earlier';
        }

        function wireMultipleChoice() {
            document.querySelectorAll('[data-activity="mc"] [data-task-id]').forEach(container => registerTask(container.dataset.taskId));
            document.querySelectorAll('[data-activity="mc"] .option-btn').forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('correct') || button.classList.contains('incorrect')) return;
                    const correct = button.dataset.correct === 'true';
                    const container = button.closest('[data-task-id]');
                    if (!container) return;
                    const taskId = container.dataset.taskId;
                    const feedback = container.querySelector('.feedback');
                    container.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        if (btn.dataset.correct === 'true') btn.classList.add('correct');
                        else btn.classList.add('incorrect');
                    });
                    if (feedback) feedback.textContent = correct ? '‚úÖ Correct!' : '‚ùå Not quite. The highlighted answer is correct.';
                    if (correct) {
                        container.classList.add('completed-success');
                        container.classList.remove('has-mistake');
                        if (taskId) markTaskSuccess(taskId);
                    } else {
                        container.classList.add('has-mistake');
                        container.classList.remove('completed-success');
                        if (taskId) recordTaskMistake(taskId);
                    }
                    if (taskId) applyTaskStyling(container, getTaskEntry(taskId));
                });
            });
            restoreMultipleChoiceState();
        }

        function wireSelectOne() {
            document.querySelectorAll('[data-activity="select"][data-task-id]').forEach(container => registerTask(container.dataset.taskId));
            document.querySelectorAll('[data-activity="select"] .option-btn').forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('correct') || button.classList.contains('incorrect')) return;
                    const correct = button.dataset.correct === 'true';
                    const container = button.closest('[data-activity="select"]');
                    if (!container) return;
                    const taskId = container.dataset.taskId;
                    const feedback = container.nextElementSibling;
                    container.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
                    button.classList.add(correct ? 'correct' : 'incorrect');
                    if (feedback && feedback.classList.contains('feedback')) {
                        feedback.textContent = correct ? '‚úÖ Well done!' : '‚ùå Try again next time.';
                    }
                    if (correct) {
                        container.classList.add('completed-success');
                        container.classList.remove('has-mistake');
                        if (taskId) markTaskSuccess(taskId);
                    } else {
                        container.classList.add('has-mistake');
                        container.classList.remove('completed-success');
                        if (taskId) recordTaskMistake(taskId);
                    }
                    if (taskId) applyTaskStyling(container, getTaskEntry(taskId));
                });
            });
            restoreSelectState();
        }

        function wireTrueFalse() {
            document.querySelectorAll('.tf-grid > div[data-task-id]').forEach(group => registerTask(group.dataset.taskId));
            document.querySelectorAll('.tf-btn').forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('correct') || button.classList.contains('incorrect')) return;
                    const correct = button.dataset.correct === 'true';
                    const group = button.parentElement;
                    const taskId = group?.dataset.taskId;
                    group.querySelectorAll('.tf-btn').forEach(btn => btn.disabled = true);
                    if (correct) {
                        button.classList.add('correct');
                        group.classList.add('completed-success');
                        group.classList.remove('has-mistake');
                        if (taskId) {
                            markTaskSuccess(taskId);
                            applyTaskStyling(group, getTaskEntry(taskId));
                        }
                    } else {
                        button.classList.add('incorrect');
                        const correctBtn = group.querySelector('.tf-btn[data-correct="true"]');
                        if (correctBtn) correctBtn.classList.add('correct');
                        group.classList.add('has-mistake');
                        group.classList.remove('completed-success');
                        if (taskId) {
                            recordTaskMistake(taskId);
                            applyTaskStyling(group, getTaskEntry(taskId));
                        }
                    }
                });
            });
            restoreTrueFalseState();
        }

        function setupMatchingGame(pairs, leftId, rightId, feedbackId, taskId, containerId) {
            const leftContainer = document.getElementById(leftId);
            const rightContainer = document.getElementById(rightId);
            const feedbackEl = document.getElementById(feedbackId);
            if (!leftContainer || !rightContainer) return;

            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';
            if (feedbackEl) feedbackEl.textContent = '';

            let selectedLeftBtn = null;
            let matchedCount = 0;
            let finished = false;

            if (taskId) registerTask(taskId);
            const containerEl = containerId ? document.getElementById(containerId) : null;

            pairs.forEach((pair, index) => {
                const btn = document.createElement('button');
                btn.className = 'matching-btn';
                btn.textContent = pair.left;
                btn.dataset.matchKey = String(index);
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('correct')) return;
                    leftContainer.querySelectorAll('.matching-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedLeftBtn = btn;
                });
                leftContainer.appendChild(btn);
            });

            const shuffled = pairs.map((pair, index) => ({ ...pair, index })).sort(() => 0.5 - Math.random());
            shuffled.forEach(({ right, index }) => {
                const btn = document.createElement('button');
                btn.className = 'matching-btn';
                btn.textContent = right;
                btn.dataset.matchKey = String(index);
                btn.addEventListener('click', () => {
                    if (!selectedLeftBtn || btn.classList.contains('correct')) return;
                    const isMatch = selectedLeftBtn.dataset.matchKey === btn.dataset.matchKey;
                    if (isMatch) {
                        btn.classList.add('correct', 'disabled');
                        selectedLeftBtn.classList.remove('selected');
                        selectedLeftBtn.classList.add('correct', 'disabled');
                        selectedLeftBtn = null;
                        matchedCount += 1;
                        if (matchedCount === pairs.length) {
                            if (feedbackEl) feedbackEl.textContent = '‚úÖ Great job! All pairs matched.';
                            if (containerEl) {
                                containerEl.classList.add('completed-success');
                                containerEl.classList.remove('has-mistake');
                            }
                            if (taskId && !finished) {
                                finished = true;
                                markTaskSuccess(taskId);
                                applyTaskStyling(containerEl, getTaskEntry(taskId));
                            }
                        }
                    } else {
                        btn.classList.add('incorrect');
                        if (containerEl) {
                            containerEl.classList.add('has-mistake');
                            containerEl.classList.remove('completed-success');
                        }
                        if (taskId && !finished) recordTaskMistake(taskId);
                        if (taskId) applyTaskStyling(containerEl, getTaskEntry(taskId));
                        setTimeout(() => btn.classList.remove('incorrect'), 600);
                    }
                });
                rightContainer.appendChild(btn);
            });

            if (taskId) {
                const entry = getTaskEntry(taskId);
                applyTaskStyling(containerEl, entry);
                if (entry?.success) {
                    finished = true;
                    if (feedbackEl) feedbackEl.textContent = '‚úÖ Completed earlier';
                    [...leftContainer.querySelectorAll('button'), ...rightContainer.querySelectorAll('button')].forEach(btn => {
                        btn.classList.add('correct', 'disabled');
                        btn.disabled = true;
                    });
                } else if (entry && entry.mistakes > 0) {
                    if (feedbackEl && !feedbackEl.textContent) feedbackEl.textContent = '‚ùå Needs another try';
                }
            }
        }

        function wireMatching() {
            const greetingPairs = [
                { left: 'Zdravo', right: 'Hello' },
                { left: 'Hvala', right: 'Thank you' },
                { left: 'Molim', right: "Please / You're welcome" },
                { left: 'Doviƒëenja', right: 'Goodbye' },
                { left: 'Dobro jutro', right: 'Good morning' },
                { left: 'Laku noƒá', right: 'Good night' }
            ];
            setupMatchingGame(greetingPairs, 'matching-left', 'matching-right', 'matching-feedback', 'practice-match-greetings', 'matching-section');
        }

        function wireQuestionMatching() {
            const qaPairs = [
                { left: 'Da li si iz Crne Gore?', right: 'Ne, nisam. Iz Srbije sam.' },
                { left: 'Da li ste Ana i Marko?', right: 'Ne, mi smo Sara i Luka.' },
                { left: 'Jesi li student?', right: 'Jesam, studiram jezike.' },
                { left: 'Da li je on tvoj brat?', right: 'Da, on je moj brat.' },
                { left: 'Da li smo spremni?', right: 'Nismo jo≈°, ƒçekamo tebe.' },
                { left: 'Da li su oni turisti?', right: 'Da, prvi put su u Podgorici.' }
            ];
            setupMatchingGame(qaPairs, 'qa-left', 'qa-right', 'qa-feedback', 'practice-match-qa', 'qa-section');
        }

        function wireDialogue() {
            const sequence = ['Zdravo!', 'Kako se zove≈°?', 'Ja sam Ana.', 'Drago mi je!'];
            const taskId = 'practice-dialogue';
            registerTask(taskId);
            const grid = document.getElementById('dialogue-grid');
            const feedback = document.getElementById('dialogue-feedback');
            const card = document.getElementById('dialogue-section');
            let index = 0;
            let finished = false;

            const shuffled = [...sequence].sort(() => 0.5 - Math.random());
            shuffled.forEach(text => {
                const btn = document.createElement('button');
                btn.className = 'dialogue-btn';
                btn.textContent = text;
                btn.addEventListener('click', () => {
                    if (btn.classList.contains('correct') || btn.classList.contains('incorrect')) return;
                    const expected = sequence[index];
                    if (text === expected) {
                        btn.classList.add('correct');
                        btn.disabled = true;
                        index += 1;
                        if (index === sequence.length) {
                            if (feedback) feedback.textContent = '‚úÖ Conversation in perfect order!';
                            if (!finished) {
                                finished = true;
                                markTaskSuccess(taskId);
                                applyTaskStyling(card, getTaskEntry(taskId));
                            }
                        }
                    } else {
                        btn.classList.add('incorrect');
                        if (!finished) {
                            recordTaskMistake(taskId);
                            applyTaskStyling(card, getTaskEntry(taskId));
                        }
                        setTimeout(() => btn.classList.remove('incorrect'), 600);
                        if (feedback) feedback.textContent = '‚ùå Try selecting the cards in order.';
                    }
                });
                grid.appendChild(btn);
            });

            const entry = getTaskEntry(taskId);
            applyTaskStyling(card, entry);
            if (entry?.success) {
                finished = true;
                if (feedback) feedback.textContent = '‚úÖ Completed earlier';
                grid.querySelectorAll('button').forEach(button => {
                    button.classList.add('correct');
                    button.disabled = true;
                });
            }
        }

        function wireFlashcards() {
            const words = [
                { front: 'Hello', back: 'Zdravo' },
                { front: 'Goodbye', back: 'Doviƒëenja' },
                { front: 'Good morning', back: 'Dobro jutro' },
                { front: 'Thank you', back: 'Hvala' },
                { front: 'Please', back: 'Molim' },
                { front: 'How are you?', back: 'Kako si?' }
            ];
            const container = document.getElementById('flashcards');
            words.forEach(({ front, back }) => {
                const card = document.createElement('div');
                card.className = 'flashcard';
                card.textContent = front;
                card.dataset.front = front;
                card.dataset.back = back;
                card.addEventListener('click', () => {
                    const flipped = card.classList.toggle('flipped');
                    card.textContent = flipped ? back : front;
                });
                container.appendChild(card);
            });
        }

        function wireChallenge() {
            const btn = document.getElementById('challenge-btn');
            const feedback = document.getElementById('challenge-feedback');
            if (!btn) return;
            const taskId = 'practice-challenge';
            registerTask(taskId);
            const card = document.querySelector('#tab-challenge .challenge-card');
            const entry = getTaskEntry(taskId);
            applyTaskStyling(card, entry);
            if (entry?.success) {
                btn.classList.add('done');
                btn.textContent = 'Great job! ‚úÖ';
                if (feedback) feedback.textContent = 'üéâ Bravo! Keep practicing in real life.';
            }
            btn.addEventListener('click', () => {
                btn.classList.toggle('done');
                const done = btn.classList.contains('done');
                btn.textContent = done ? 'Great job! ‚úÖ' : 'I did it!!';
                if (feedback) feedback.textContent = done ? 'üéâ Bravo! Keep practicing in real life.' : '';
                if (done) {
                    markTaskSuccess(taskId);
                } else {
                    resetTaskProgress(taskId);
                }
                applyTaskStyling(card, getTaskEntry(taskId));
            });
        }

        function initTabs() {
            const buttons = document.querySelectorAll('.tab-button');
            const panels = document.querySelectorAll('.tab-panel');
            const activate = key => {
                buttons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === key));
                panels.forEach(panel => panel.classList.toggle('active', panel.id === `tab-${key}`));
            };
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.dataset.tab;
                    activate(target);
                    const tabsTop = document.querySelector('.lesson-tabs');
                    if (tabsTop) {
                        tabsTop.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        }

        function handleRetake() {
            localStorage.removeItem(LESSON_TASK_PROGRESS_KEY);
            lessonTaskProgress = { tasks: {} };
            updateLessonProgressUI();
            window.location.reload();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadLessonTaskProgress();
            loadProgress();
            if (lessonRetakeBtn) lessonRetakeBtn.addEventListener('click', handleRetake);
            if (floatingRetakeBtn) floatingRetakeBtn.addEventListener('click', handleRetake);

            const fullVocab = collectLessonVocabulary();
            renderVocabularyCards(fullVocab);
            updateProgressBar();

            restoreMiniTasks();
            initTabs();
            wireMultipleChoice();
            wireMatching();
            wireQuestionMatching();
            wireSelectOne();
            wireDialogue();
            wireTrueFalse();
            wireFlashcards();
            wireChallenge();
            updateLessonProgressUI();
        });
    </script>
</body>
</html>
