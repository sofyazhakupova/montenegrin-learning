<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Trainer - Learn Montenegrin</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .lesson-container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .lesson-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .lesson-title {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .lesson-description {
            color: var(--text-light);
            font-size: 1.125rem;
        }

        .progress-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .progress-label {
            font-weight: 600;
            color: var(--text-light);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            border-radius: 999px;
            background: var(--bg-light);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--success-color);
            border-radius: 999px;
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .tab-button {
            padding: 0.65rem 1.15rem;
            border-radius: 999px;
            border: 1px solid var(--bg-light);
            background: var(--white);
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button:hover,
        .tab-button.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
        }

        .vocab-card {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--bg-light);
            box-shadow: var(--shadow);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-height: 110px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .vocab-card:hover {
            transform: translateY(-3px);
        }

        .vocab-card.known {
            border-width: 2px;
        }

        .vocab-card.known-level-a1 {
            border-color: rgba(45, 90, 135, 0.45);
            background: rgba(45, 90, 135, 0.12);
        }

        .vocab-card.known-level-a2 {
            border-color: rgba(243, 156, 18, 0.45);
            background: rgba(243, 156, 18, 0.12);
        }

        .vocab-card.known-level-b1 {
            border-color: rgba(142, 68, 173, 0.45);
            background: rgba(142, 68, 173, 0.12);
        }

        .vocab-word {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .level-badge {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem;
            background: rgba(45, 90, 135, 0.08);
            color: var(--primary-color);
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .note-text {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
        }

        .card-actions button {
            flex: 1;
            padding: 0.45rem 0.6rem;
            border-radius: 8px;
            border: 1px solid var(--bg-light);
            background: var(--white);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }

        .card-actions button.know {
            border-color: rgba(39, 174, 96, 0.25);
            color: var(--success-color);
        }

        .card-actions button.dont-know {
            border-color: rgba(243, 156, 18, 0.25);
            color: #f39c12;
        }

        .card-actions button:hover:not(:disabled) {
            background: var(--bg-light);
        }

        .card-actions button:disabled {
            opacity: 0.45;
            cursor: default;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 1000;
        }

        .modal-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            max-width: 520px;
            width: calc(100% - 3rem);
            box-shadow: var(--shadow-hover);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-word {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.35rem;
        }

        .modal-translation {
            font-size: 1.1rem;
            color: var(--text-light);
        }

        .modal-status {
            margin-top: 0.4rem;
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .modal-badge {
            display: inline-block;
            background: rgba(45, 90, 135, 0.08);
            color: var(--primary-color);
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.4rem;
        }

        .modal-section {
            margin-top: 1.3rem;
        }

        .modal-section h4 {
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .verb-table {
            border: 1px solid rgba(45, 90, 135, 0.12);
            border-radius: 8px;
            overflow: hidden;
        }

        .verb-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .verb-table th,
        .verb-table td {
            padding: 0.45rem 0.6rem;
            text-align: left;
        }

        .verb-table thead {
            background: rgba(45, 90, 135, 0.1);
            font-weight: 600;
        }

        .modal-list {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .modal-actions button {
            flex: 1;
            min-width: 150px;
            padding: 0.6rem 1rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-actions button.primary {
            background: var(--success-color);
            color: var(--white);
        }

        .modal-actions button.secondary {
            background: rgba(243, 156, 18, 0.15);
            color: #c47a0f;
        }

        .modal-actions button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .modal-actions button:disabled {
            opacity: 0.45;
            cursor: default;
            transform: none;
        }

        @media (max-width: 700px) {
            .lesson-container {
                padding: 1.5rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .modal {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">üá≤üá™ Learn Montenegrin</div>
            <div class="nav-links">
                <a href="index.html">Dashboard</a>
                <a href="lessons.html">Lessons</a>
                <a href="vocab.html">Vocabulary</a>
                <a href="quiz.html">Quiz</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="lesson-container">
            <a href="index.html" class="back-link">‚Üê Back to Home</a>

            <div class="lesson-header">
                <h1 class="lesson-title">Vocabulary Trainer</h1>
                <p class="lesson-description">Browse every lesson‚Äôs words by category. Click any card to see translations and verb conjugations.</p>
            </div>

                <div class="progress-wrapper">
                <div class="progress-label" id="progress-label">Loading progress‚Ä¶</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>

            <div id="category-tabs" class="tabs"></div>
            <div id="cards-container" class="cards-grid"></div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Learn Montenegrin. Made with ‚ù§Ô∏è for language learners.</p>
    </footer>

    <script src="lessons-data.js"></script>
    <script src="vocab/vocab-data.js"></script>
    <script>
        const CATEGORY_LABELS = {
            pronoun: 'Pronouns',
            verb: 'Verbs',
            noun: 'Nouns',
            adjective: 'Adjectives',
            adverb: 'Adverbs & Particles',
            phrase: 'Phrases',
            reference: 'References',
            note: 'Notes',
            focus: 'Focus',
            other: 'Other'
        };
        const CATEGORY_ORDER = ['pronoun', 'verb', 'noun', 'adjective', 'adverb', 'phrase', 'reference', 'focus', 'note', 'other'];
        const PROGRESS_KEY = 'vocab_progress_all';
        const LEVEL_CLASS_MAP = {
            a1: 'known-level-a1',
            a2: 'known-level-a2',
            b1: 'known-level-b1',
            b2: 'known-level-b2'
        };

        let wordProgress = {};
        let cardRegistry = new Map();
        let allWordKeys = [];
        let currentModalWord = null;
        let currentModalWordKey = null;
        let currentModalLevel = null;

        const tabsEl = document.getElementById('category-tabs');
        const cardsEl = document.getElementById('cards-container');
        const progressLabelEl = document.getElementById('progress-label');
        const progressFillEl = document.getElementById('progress-fill');

        const modalBackdrop = document.createElement('div');
        modalBackdrop.className = 'modal-backdrop';
        modalBackdrop.innerHTML = `
            <div class="modal">
                <button class="modal-close" aria-label="Close">√ó</button>
                <div class="modal-word" id="modal-word"></div>
                <div class="modal-translation" id="modal-translation"></div>
                <div class="modal-status" id="modal-status"></div>
                <div class="modal-section" id="modal-conjugations" hidden>
                    <h4>Present tense</h4>
                    <div class="verb-table">
                        <table>
                            <thead><tr><th>Pronoun</th><th>Form</th></tr></thead>
                            <tbody id="modal-conjugations-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-section" id="modal-lessons" hidden>
                    <h4>Appears in lessons</h4>
                    <div class="modal-list" id="modal-lessons-list"></div>
                </div>
                <div class="modal-section" id="modal-notes" hidden>
                    <h4>Notes</h4>
                    <div class="modal-list" id="modal-note-text"></div>
                </div>
                <div class="modal-actions">
                    <button class="primary" id="modal-know-btn">I know this</button>
                    <button class="secondary" id="modal-dont-know-btn">I don't know yet</button>
                </div>
            </div>
        `;
        document.body.appendChild(modalBackdrop);

        const modalCloseBtn = modalBackdrop.querySelector('.modal-close');
        const modalWord = document.getElementById('modal-word');
        const modalTranslation = document.getElementById('modal-translation');
        const modalStatus = document.getElementById('modal-status');
        const modalConjugations = document.getElementById('modal-conjugations');
        const modalConjugationsBody = document.getElementById('modal-conjugations-body');
        const modalLessons = document.getElementById('modal-lessons');
        const modalLessonsList = document.getElementById('modal-lessons-list');
        const modalNotes = document.getElementById('modal-notes');
        const modalNoteText = document.getElementById('modal-note-text');
        const modalKnowBtn = document.getElementById('modal-know-btn');
        const modalDontKnowBtn = document.getElementById('modal-dont-know-btn');

        function getWordKey(word) {
            return (word || '').toLowerCase();
        }

        function levelRank(level) {
            if (!level) return 999;
            const match = level.match(/^([A-Ca-c])(\d)/);
            if (!match) return 999;
            const groupMap = { A: 0, B: 10, C: 20 };
            const major = groupMap[match[1].toUpperCase()] ?? 99;
            const minor = parseInt(match[2], 10) || 0;
            return major + minor;
        }

        function primaryLevel(levels) {
            if (!levels || !levels.length) return null;
            return [...levels].sort((a, b) => levelRank(a) - levelRank(b))[0];
        }

        function getLevelClass(level) {
            if (!level) return null;
            const key = level.slice(0, 2).toLowerCase();
            return LEVEL_CLASS_MAP[key] || null;
        }

        function normalizeCategory(category) {
            const type = (category.type || '').toLowerCase();
            switch (type) {
                case 'pronoun':
                case 'verb':
                case 'noun':
                case 'adjective':
                case 'adverb':
                case 'phrase':
                case 'reference':
                case 'focus':
                case 'note':
                    return type;
                default:
                    break;
            }

            const name = (category.name || '').toLowerCase();
            if (name.includes('pronoun')) return 'pronoun';
            if (name.includes('verb')) return 'verb';
            if (name.includes('noun')) return 'noun';
            if (name.includes('adjective')) return 'adjective';
            if (name.includes('adverb')) return 'adverb';
            if (name.includes('phrase')) return 'phrase';
            if (name.includes('reference')) return 'reference';
            if (name.includes('focus')) return 'focus';
            if (name.includes('note')) return 'note';
            return 'other';
        }

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                const parsed = stored ? JSON.parse(stored) : {};
                wordProgress = (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) ? parsed : {};
            } catch (error) {
                wordProgress = {};
            }
        }

        function saveProgress() {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(wordProgress));
            } catch (error) {
                // ignore storage issues
            }
        }

        function getWordStatusByKey(key) {
            return wordProgress[key] === 'known' ? 'known' : 'unknown';
        }

        function setWordStatusByKey(key, status) {
            wordProgress[key] = status === 'known' ? 'known' : 'unknown';
            saveProgress();
            updateCardGroup(key);
            if (currentModalWordKey === key) {
                updateModalStatus(key);
            }
            updateProgressBar();
        }

        function setWordStatus(word, status) {
            setWordStatusByKey(getWordKey(word), status);
        }

        function updateCardGroup(key) {
            const status = getWordStatusByKey(key);
            const cards = cardRegistry.get(key) || [];
            cards.forEach(card => updateCardVisual(card, status));
        }

        function updateCardVisual(card, status) {
            card.classList.remove('known', 'known-level-a1', 'known-level-a2', 'known-level-b1', 'known-level-b2');
            if (status === 'known') {
                card.classList.add('known');
                const levelClass = getLevelClass(card.dataset.level);
                if (levelClass) card.classList.add(levelClass);
            }
            const knowBtn = card.querySelector('button.know');
            const dontBtn = card.querySelector('button.dont-know');
            if (knowBtn) knowBtn.disabled = status === 'known';
            if (dontBtn) dontBtn.disabled = status !== 'known';
        }

        function updateModalStatus(key) {
            const status = getWordStatusByKey(key);
            const levelSuffix = currentModalLevel ? ` ‚Ä¢ Level ${currentModalLevel}` : '';
            modalStatus.textContent = (status === 'known' ? 'Marked as known' : 'Not marked as known yet') + levelSuffix;
            modalKnowBtn.disabled = status === 'known';
            modalDontKnowBtn.disabled = status !== 'known';
        }

        function updateProgressBar() {
            const total = allWordKeys.length;
            if (!total) {
                progressLabelEl.textContent = 'No vocabulary words available yet.';
                progressFillEl.style.width = '0%';
                return;
            }
            let knownCount = 0;
            allWordKeys.forEach(key => {
                if (wordProgress[key] === 'known') knownCount += 1;
            });
            const percent = (knownCount / total) * 100;
            progressLabelEl.textContent = `You already know ${percent.toFixed(2)}% (${knownCount} of ${total})`;
            progressFillEl.style.width = `${percent}%`;
        }

        function buildCategoryIndex() {
            const categoryBuckets = new Map();
            const masterMap = new Map();

            Object.entries(vocabularyData).forEach(([lessonKey, lesson]) => {
                if (!lesson || !lesson.categories) return;
                const lessonTitle = lesson.title || lessonKey;
                const lessonLevel = lessonsData?.[lessonKey]?.level || null;

                lesson.categories.forEach(category => {
                    const typeKey = normalizeCategory(category);
                    if (!categoryBuckets.has(typeKey)) {
                        categoryBuckets.set(typeKey, new Map());
                    }
                    const bucket = categoryBuckets.get(typeKey);

                    (category.items || []).forEach(item => {
                        if (!item || !item.word) return;
                        const wordKey = getWordKey(item.word);

                        let entry = masterMap.get(wordKey);
                        if (!entry) {
                            entry = {
                                word: item.word,
                                translation: item.translation || '',
                                conjugations: item.conjugations || null,
                                note: item.note || null,
                                reference: item.reference || null,
                                lessons: new Set(),
                                levels: new Set(),
                                shared: lessonKey === 'shared'
                            };
                            masterMap.set(wordKey, entry);
                        } else {
                            if (item.translation) entry.translation = item.translation;
                            if (item.conjugations) entry.conjugations = item.conjugations;
                            if (item.note) entry.note = item.note;
                            if (item.reference) entry.reference = item.reference;
                            if (lessonKey === 'shared') entry.shared = true;
                        }

                        if (lessonKey !== 'shared' && lessonTitle) {
                            entry.lessons.add(lessonTitle);
                        }
                        if (lessonLevel) {
                            entry.levels.add(lessonLevel);
                        }

                        if (!bucket.has(wordKey)) {
                            bucket.set(wordKey, entry);
                        }
                    });
                });
            });

            allWordKeys = Array.from(masterMap.keys());

            const categories = [];
            const orderedKeys = CATEGORY_ORDER.concat(Array.from(categoryBuckets.keys()).filter(key => !CATEGORY_ORDER.includes(key)));

            orderedKeys.forEach(key => {
                if (!categoryBuckets.has(key)) return;
                const items = Array.from(categoryBuckets.get(key).values())
                    .map(entry => {
                        const levels = entry.levels ? Array.from(entry.levels) : [];
                        return {
                            word: entry.word,
                            translation: entry.translation,
                            conjugations: entry.conjugations,
                            note: entry.note,
                            reference: entry.reference,
                            lessons: Array.from(entry.lessons),
                            shared: entry.shared,
                            levels,
                            primaryLevel: primaryLevel(levels)
                        };
                    })
                    .sort((a, b) => a.word.localeCompare(b.word, 'sr'));
                if (items.length) {
                    categories.push({ key, label: CATEGORY_LABELS[key] || key, items });
                }
            });

            return categories;
        }

        function openModal(item, categoryLabel) {
            currentModalWord = item.word;
            currentModalWordKey = getWordKey(item.word);
            currentModalLevel = item.primaryLevel || null;

            modalWord.textContent = item.word;
            modalTranslation.innerHTML = `${item.translation || '‚Äî'} <span class="modal-badge">${categoryLabel}</span>`;

            if (item.conjugations) {
                modalConjugations.hidden = false;
                modalConjugationsBody.innerHTML = '';
                Object.entries(item.conjugations).forEach(([pronoun, form]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${pronoun}</td><td>${form}</td>`;
                    modalConjugationsBody.appendChild(row);
                });
            } else {
                modalConjugations.hidden = true;
            }

            if (item.lessons && item.lessons.length) {
                modalLessons.hidden = false;
                modalLessonsList.textContent = item.lessons.join(', ');
            } else if (item.shared) {
                modalLessons.hidden = false;
                modalLessonsList.textContent = 'Shared reference list';
            } else {
                modalLessons.hidden = true;
            }

            if (item.note || item.reference) {
                modalNotes.hidden = false;
                modalNoteText.textContent = item.note || item.reference;
            } else {
                modalNotes.hidden = true;
            }

            updateModalStatus(currentModalWordKey);
            modalBackdrop.classList.add('open');
        }

        function closeModal() {
            modalBackdrop.classList.remove('open');
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', event => {
            if (event.target === modalBackdrop) closeModal();
        });
        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') closeModal();
        });

        modalKnowBtn.addEventListener('click', () => {
            if (currentModalWord) setWordStatus(currentModalWord, 'known');
        });

        modalDontKnowBtn.addEventListener('click', () => {
            if (currentModalWord) setWordStatus(currentModalWord, 'unknown');
        });

        function createCard(item, categoryLabel) {
                const card = document.createElement('div');
                card.className = 'vocab-card';
            card.dataset.level = (item.primaryLevel || '').toLowerCase();
            card.addEventListener('click', () => openModal(item, categoryLabel));

            const wordEl = document.createElement('div');
            wordEl.className = 'vocab-word';
            wordEl.textContent = item.word;
            card.appendChild(wordEl);

            if (item.primaryLevel) {
                const levelEl = document.createElement('div');
                levelEl.className = 'level-badge';
                levelEl.textContent = item.primaryLevel;
                card.appendChild(levelEl);
            }

            if (item.note || item.reference) {
                const noteEl = document.createElement('div');
                noteEl.className = 'note-text';
                noteEl.textContent = item.note || item.reference;
                card.appendChild(noteEl);
            }

                const actions = document.createElement('div');
                actions.className = 'card-actions';

            const knowBtn = document.createElement('button');
            knowBtn.className = 'know';
            knowBtn.textContent = 'I know';
            knowBtn.addEventListener('click', event => {
                event.stopPropagation();
                    setWordStatus(item.word, 'known');
                });

            const dontBtn = document.createElement('button');
            dontBtn.className = 'dont-know';
            dontBtn.textContent = 'Practice';
            dontBtn.addEventListener('click', event => {
                event.stopPropagation();
                    setWordStatus(item.word, 'unknown');
                });

            actions.appendChild(knowBtn);
            actions.appendChild(dontBtn);
                card.appendChild(actions);

            const wordKey = getWordKey(item.word);
            if (!cardRegistry.has(wordKey)) {
                cardRegistry.set(wordKey, []);
            }
            cardRegistry.get(wordKey).push(card);
            updateCardVisual(card, getWordStatusByKey(wordKey));

            return card;
        }

        let currentCategory = null;

        function renderCategory(category) {
            cardRegistry = new Map();
            currentCategory = category;
            cardsEl.innerHTML = '';
            if (!category || !category.items.length) {
                cardsEl.innerHTML = '<p style="color: var(--text-light);">No words in this category yet.</p>';
                return;
            }
            category.items.forEach(item => {
                cardsEl.appendChild(createCard(item, category.label));
            });
        }

        function init() {
            loadProgress();
            const categories = buildCategoryIndex();
            updateProgressBar();

            tabsEl.innerHTML = '';

            if (!categories.length) {
                cardsEl.innerHTML = '<p style="color: var(--text-light);">Vocabulary data not available.</p>';
                return;
            }

            categories.forEach((category, index) => {
                const button = document.createElement('button');
                button.className = 'tab-button';
                button.textContent = category.label;
                button.dataset.tab = category.key;
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderCategory(category);
                });
                tabsEl.appendChild(button);

                if (index === 0) {
                    button.classList.add('active');
                    renderCategory(category);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
